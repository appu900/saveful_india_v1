generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pg_trgm]
}

enum UserRole {
  ADMIN
  USER
  CHEF
}

enum RecipeDifficulty {
  EASY
  MEDIUM
  HARD
}

enum RecipeType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
  DESSERT
  BEVERAGE
  APPETIZER
  MAIN_COURSE
  SIDE_DISH
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
  ALL_SEASON
}

enum IngredientType {
  VEGETABLE
  FRUIT
  GRAIN
  PROTEIN
  DAIRY
  SPICE
  OIL
  CONDIMENT
  HERB
  NUT
  SEED
  OTHER
}

// ============================================
// USER MODELS
// ============================================

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  phoneNumber  String? @unique
  name         String
  role         UserRole @default(USER)
  stateCode    String?
  regionId     String?

  tokenSet         TokenSet?
  sessions         UserSession[]
  dietaryProfile   UserDietProfile?
  cookedRecipes    CookedRecipe[]
  bookmarkedRecipes BookmarkedRecipe[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  region    Region?  @relation(fields: [regionId], references: [id])
}

model TokenSet {
  userId      String   @id
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshHash String?
  updatedAt   DateTime @updatedAt
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  device       String?
  ipAddress    String?
  userAgent    String?
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([lastActivity])
}

model UserDietProfile {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  vegType        String
  dairyFree      Boolean  @default(false)
  nutFree        Boolean  @default(false)
  glutenFree     Boolean  @default(false)
  hasDiabetes    Boolean  @default(false)
  otherAllergies String[]

  updatedAt DateTime @updatedAt
}

// ============================================
// USER RECIPE INTERACTIONS
// ============================================

model CookedRecipe {
  id String @id @default(uuid())
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  cookedAt DateTime @default(now())
  rating   Int?     // 1-5 stars
  notes    String?  // User's cooking notes
  
  @@unique([userId, recipeId, cookedAt])
  @@index([userId])
  @@index([recipeId])
  @@index([cookedAt])
}

model BookmarkedRecipe {
  id String @id @default(uuid())
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, recipeId])
  @@index([userId])
  @@index([recipeId])
}

// ============================================
// INGREDIENT MODELS
// ============================================

model IngredientCategory {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  sortOrder   Int          @default(0)
  ingredients Ingredient[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([sortOrder])
}

model Ingredient {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  aliases     String[] @default([])
  
  imageUrl      String?
  description   String?
  nutritionInfo Json?   // Structured nutrition data
  
  type             IngredientType @default(OTHER)
  availableSeasons Season[]       @default([ALL_SEASON])
  
  categoryId String?
  category   IngredientCategory? @relation(fields: [categoryId], references: [id])
  
  // Dietary properties
  isVeg    Boolean @default(true)
  isVegan  Boolean @default(true)
  isDairy  Boolean @default(false)
  isNut    Boolean @default(false)
  isGluten Boolean @default(false)
  
  tags String[] @default([])
  
  addedBy    UserRole @default(ADMIN)
  isVerified Boolean  @default(false)
  
  recipeIngredients RecipeIngredient[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([name])
  @@index([slug])
  @@index([categoryId])
  @@index([type])
  @@index([isVerified])
}

// ============================================
// RECIPE MODEL - MAIN
// ============================================

model Recipe {
  id    String @id @default(uuid())
  title String
  slug  String @unique
  
  // About the dish
  shortDescription String  // Brief description
  longDescription  String  @db.Text // Full description
  
  // Hacks & Tips
  hacksAndTips String[] @default([]) // Array of tips
  
  // Media
  imageUrl    String?
  youtubeUrl  String?
  
  // Recipe metadata
  portions         String? // e.g., "4 servings", "2-3 people"
  prepAndCookTime  String? // e.g., "~30min", "1 hour"
  difficulty       RecipeDifficulty @default(EASY)
  recipeType       RecipeType       @default(MAIN_COURSE)
  
  // Preparation instructions
  prepShortDescription String?        // Brief prep note
  prepLongDescription  String?  @db.Text // Detailed prep instructions
  
  // Cooking instructions
  cookingInstructions String @db.Text
  
  // Relations
  regionId String?
  region   Region? @relation(fields: [regionId], references: [id])
  
  ingredients RecipeIngredient[]
  
  // Dietary flags (computed from ingredients)
  isVeg            Boolean @default(false)
  isVegan          Boolean @default(false)
  dairyFree        Boolean @default(true)
  nutFree          Boolean @default(true)
  glutenFree       Boolean @default(true)
  diabetesFriendly Boolean @default(false)
  
  // ðŸš€ DENORMALIZED for fast search
  ingredientIds    String[] @default([])
  ingredientNames  String[] @default([])
  ingredientSlugs  String[] @default([])
  searchText       String?  // Combined searchable text
  
  // Stats
  viewCount     Int @default(0)
  cookCount     Int @default(0)
  bookmarkCount Int @default(0)
  avgRating     Float? @default(0)
  
  // User interactions
  cookedByUsers     CookedRecipe[]
  bookmarkedByUsers BookmarkedRecipe[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([slug])
  @@index([recipeType])
  @@index([difficulty])
  @@index([regionId])
  @@index([isVeg, isVegan, dairyFree, nutFree, glutenFree])
  @@index([cookCount])
  @@index([avgRating])
  @@index([createdAt])
}

// ============================================
// RECIPE INGREDIENTS - JUNCTION TABLE
// ============================================

model RecipeIngredient {
  id String @id @default(uuid())
  
  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  // Ingredient category for grouping
  categoryName String? // e.g., "CRISPY RICE", "RED CURRY DRESSING", "VEGGIES"
  sortOrder    Int     @default(0) // Order within recipe
  
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  
  // Instructions for this ingredient
  instruction String? // e.g., "Aim for 2 cups" or "500gm"
  
  // Quantity details (optional, can be in instruction)
  quantity   Float?
  unit       String?
  
  // Recommended alternatives
  isRecommended Boolean  @default(true)
  alternatives  String[] @default([]) // Alternative ingredient names
  
  isOptional Boolean @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([recipeId, sortOrder])
  @@index([ingredientId])
  @@index([categoryName])
}

// ============================================
// REGION MODEL
// ============================================

model Region {
  id          String   @id @default(uuid())
  countryCode String
  stateCode   String?
  name        String
  type        String
  parentId    String?
  parent      Region?  @relation("RegionParent", fields: [parentId], references: [id])
  children    Region[] @relation("RegionParent")
  
  users   User[]
  recipes Recipe[]
  
  @@index([parentId])
  @@index([countryCode])
}

// ============================================
// POST-MIGRATION SQL
// Execute after running: npx prisma migrate dev
// ============================================

/*
-- Enable pg_trgm extension
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- GIN index for ingredient names array (overlap searches)
CREATE INDEX IF NOT EXISTS "Recipe_ingredientNames_array_idx" 
  ON "Recipe" USING GIN ("ingredientNames");

-- GIN index for searchText with trigram (fuzzy text search)
CREATE INDEX IF NOT EXISTS "Recipe_searchText_trgm_idx" 
  ON "Recipe" USING GIN ("searchText" gin_trgm_ops);

-- GIN index for ingredient slugs array
CREATE INDEX IF NOT EXISTS "Recipe_ingredientSlugs_array_idx" 
  ON "Recipe" USING GIN ("ingredientSlugs");

-- GIN index for hacks and tips array
CREATE INDEX IF NOT EXISTS "Recipe_hacksAndTips_array_idx" 
  ON "Recipe" USING GIN ("hacksAndTips");

-- GIN index for ingredient name with trigram
CREATE INDEX IF NOT EXISTS "Ingredient_name_trgm_idx" 
  ON "Ingredient" USING GIN ("name" gin_trgm_ops);

-- GIN index for ingredient aliases
CREATE INDEX IF NOT EXISTS "Ingredient_aliases_array_idx" 
  ON "Ingredient" USING GIN ("aliases");
*/