generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pg_trgm]
}

enum UserRole {
  ADMIN
  USER
  CHEF
}

enum RecipeDifficulty {
  EASY
  MEDIUM
  HARD
}

enum RecipeType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
  DESSERT
  BEVERAGE
  APPETIZER
  MAIN_COURSE
  SIDE_DISH
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
  ALL_SEASON
}

enum IngredientType {
  VEGETABLE
  FRUIT
  GRAIN
  PROTEIN
  DAIRY
  SPICE
  OIL
  CONDIMENT
  HERB
  NUT
  SEED
  OTHER
}



model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  phoneNumber  String?  @unique
  name         String
  role         UserRole @default(USER)
  stateCode    String?
  regionId     String?

  tokenSet          TokenSet?
  sessions          UserSession[]
  dietaryProfile    UserDietProfile?
  onboarding        UserOnboarding?
  cookedRecipes     CookedRecipe[]
  bookmarkedRecipes BookmarkedRecipe[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  region    Region?  @relation(fields: [regionId], references: [id])
}

model TokenSet {
  userId      String   @id
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshHash String?
  updatedAt   DateTime @updatedAt
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  device       String?
  ipAddress    String?
  userAgent    String?
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([lastActivity])
}

model UserDietProfile {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  vegType        String
  dairyFree      Boolean  @default(false)
  nutFree        Boolean  @default(false)
  glutenFree     Boolean  @default(false)
  hasDiabetes    Boolean  @default(false)
  otherAllergies String[]

  updatedAt DateTime @updatedAt
}

model UserOnboarding {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  postcode         String   // Country code
  suburb           String   // Country name
  noOfAdults       Int      @default(1)
  noOfChildren     Int      @default(0)
  tastePreference  String[] @default([])
  trackSurveyDay   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model CookedRecipe {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  cookedAt DateTime @default(now())
  rating   Int? // 1-5 stars
  notes    String? // User's cooking notes

  @@unique([userId, recipeId, cookedAt])
  @@index([userId])
  @@index([recipeId])
  @@index([cookedAt])
}

model BookmarkedRecipe {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, recipeId])
  @@index([userId])
  @@index([recipeId])
}

model IngredientCategory {
  id          String       @id @default(uuid())
  name        String       @unique
  description String?
  sortOrder   Int          @default(0)
  ingredients Ingredient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sortOrder])
}

model Ingredient {
  id      String   @id @default(uuid())
  name    String   @unique
  slug    String   @unique
  aliases String[] @default([])

  imageUrl      String?
  description   String?
  nutritionInfo String? // Structured nutrition data

  type             IngredientType @default(OTHER)
  availableSeasons Season[]       @default([ALL_SEASON])

  categoryId String?
  category   IngredientCategory? @relation(fields: [categoryId], references: [id])

  // Dietary properties
  isVeg       Boolean  @default(true)
  isVegan     Boolean  @default(true)
  isDairy     Boolean  @default(false)
  isNut       Boolean  @default(false)
  isGluten    Boolean  @default(false)
  isFruit     Boolean?
  isVegetable Boolean?

  tags String[] @default([])

  addedBy    UserRole @default(ADMIN)
  isVerified Boolean  @default(false)

  recipeIngredients RecipeIngredient[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([slug])
  @@index([categoryId])
  @@index([type])
  @@index([isVerified])
}

// ============================================
// RECIPE MODEL - MAIN
// ============================================

model Recipe {
  id   String @id @default(uuid())
  name String // Recipe name
  slug String @unique

  // Basic Info
  portions        String? // e.g., "4 servings"
  prepAndCookTime String? // e.g., "~30min"
  imageUrl        String? // Recipe image

  // Descriptions
  aboutThisDish String @db.Text // About the dish description
  proTip        String @db.Text // Pro tips for cooking

  // Saving technique
  savingTechnique String? @db.Text // How to save/store the dish

  // Media
  youtubeUrl String? // YouTube video link

  // Recipe metadata
  difficulty RecipeDifficulty @default(EASY)
  recipeType RecipeType       @default(MAIN_COURSE)

  // Relations
  regionId String?
  region   Region? @relation(fields: [regionId], references: [id])

  ingredientCategories RecipeIngredientCategory[]
  cookingSteps         CookingStep[]

  // Dietary flags (computed from ingredients)
  isVeg            Boolean @default(false)
  isVegan          Boolean @default(false)
  dairyFree        Boolean @default(true)
  nutFree          Boolean @default(true)
  glutenFree       Boolean @default(true)
  diabetesFriendly Boolean @default(false)

  // ðŸš€ DENORMALIZED for fast search
  ingredientIds   String[] @default([])
  ingredientNames String[] @default([])
  ingredientSlugs String[] @default([])
  searchText      String? // Combined searchable text

  // Stats
  viewCount     Int   @default(0)
  cookCount     Int   @default(0)
  bookmarkCount Int   @default(0)
  avgRating     Float @default(0)

  // User interactions
  cookedByUsers     CookedRecipe[]
  bookmarkedByUsers BookmarkedRecipe[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([recipeType])
  @@index([difficulty])
  @@index([regionId])
  @@index([isVeg, isVegan, dairyFree, nutFree, glutenFree])
  @@index([cookCount])
  @@index([avgRating])
  @@index([createdAt])
  @@index([name])
}

// ============================================
// RECIPE INGREDIENT CATEGORIES
// ============================================

model RecipeIngredientCategory {
  id String @id @default(uuid())

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  categoryName String // e.g., "Rice", "Oil", "Spices"
  sortOrder    Int    @default(0)

  // Ingredients in this category
  ingredients RecipeIngredient[]

  createdAt DateTime @default(now())

  @@index([recipeId, sortOrder])
}

// ============================================
// RECIPE INGREDIENTS
// ============================================

model RecipeIngredient {
  id String @id @default(uuid())

  categoryId String
  category   RecipeIngredientCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  // Quantity details
  quantity String // e.g., "2 cups", "500gm", "3 tbsp"

  // Is this ingredient required or optional?
  isOptional Boolean @default(false)

  sortOrder Int @default(0)

  createdAt DateTime @default(now())

  @@index([categoryId, sortOrder])
  @@index([ingredientId])
}

// ============================================
// COOKING STEPS
// ============================================

model CookingStep {
  id String @id @default(uuid())

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  stepNumber  Int // Step order (1, 2, 3, etc.)
  title       String // Step title (optional, can be empty)
  instruction String @db.Text // Step instructions

  imageUrl String? // Optional image for this step

  createdAt DateTime @default(now())

  @@unique([recipeId, stepNumber])
  @@index([recipeId, stepNumber])
}

// ============================================
// REGION MODEL
// ============================================

model Region {
  id          String   @id @default(uuid())
  countryCode String
  stateCode   String?
  name        String
  type        String
  parentId    String?
  parent      Region?  @relation("RegionParent", fields: [parentId], references: [id])
  children    Region[] @relation("RegionParent")

  users   User[]
  recipes Recipe[]

  @@index([parentId])
  @@index([countryCode])
}

// ============================================
// POST-MIGRATION SQL
// Execute after running: npx prisma migrate dev
// ============================================

/**
 * -- Enable pg_trgm extension
 * CREATE EXTENSION IF NOT EXISTS pg_trgm;
 * -- GIN index for ingredient names array (overlap searches)
 * CREATE INDEX IF NOT EXISTS "Recipe_ingredientNames_array_idx"
 * ON "Recipe" USING GIN ("ingredientNames");
 * -- GIN index for searchText with trigram (fuzzy text search)
 * CREATE INDEX IF NOT EXISTS "Recipe_searchText_trgm_idx"
 * ON "Recipe" USING GIN ("searchText" gin_trgm_ops);
 * -- GIN index for ingredient slugs array
 * CREATE INDEX IF NOT EXISTS "Recipe_ingredientSlugs_array_idx"
 * ON "Recipe" USING GIN ("ingredientSlugs");
 * -- GIN index for ingredient name with trigram
 * CREATE INDEX IF NOT EXISTS "Ingredient_name_trgm_idx"
 * ON "Ingredient" USING GIN ("name" gin_trgm_ops);
 * -- GIN index for ingredient aliases
 * CREATE INDEX IF NOT EXISTS "Ingredient_aliases_array_idx"
 * ON "Ingredient" USING GIN ("aliases");
 */
