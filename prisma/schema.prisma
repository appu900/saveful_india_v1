generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [vector()]
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  phoneNumber  String? @unique
  name         String

  role      UserRole @default(USER)
  stateCode String?
  regionId  String?

  tokenSet TokenSet?
  sessions UserSession[]

  dietaryProfile UserDietProfile?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  region    Region?  @relation(fields: [regionId], references: [id])
}

model TokenSet {
  userId      String   @id
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refershHash String?
  updatedAt   DateTime @updatedAt
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  device       String?
  ipAddress    String?
  userAgent    String?
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())
}

model UserDietProfile {
  userId String @id
  user   User   @relation(fields: [userId], references: [id])

  vegType        String
  dairyFree      Boolean  @default(false)
  nutFree        Boolean  @default(false)
  glutenFree     Boolean  @default(false)
  hasDiabetes    Boolean  @default(false)
  otherAllergies String[]

  updatedAt DateTime @updatedAt
}

model IngredientCategory {
  id          String       @id @default(uuid())
  name        String
  description String
  ingredients Ingredient[]
}

model Ingredient {
  id      String   @id @default(uuid())
  name    String   @unique
  slug    String   @unique
  aliases String[] @default([])

  categoryId String?
  category   IngredientCategory? @relation(fields: [categoryId], references: [id])

  isVeg   Boolean @default(true)
  isVegan Boolean @default(true)

  isDairy  Boolean @default(false)
  isNut    Boolean @default(false)
  isGluten Boolean @default(false)

  tags String[] @default([])

  recipes RecipeIngredient[]
}

model MealCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  recipes     Recipe[]
}

model Recipe {
  id String @id @default(uuid())

  title            String
  slug             String  @unique
  shortDescription String?
  instructions     String // full recipe steps
  imageUrl         String?

  cookingTimeMinutes Int?
  difficulty         RecipeDifficulty @default(EASY)

  // Relations
  regionId String?
  region   Region? @relation("RecipeRegion", fields: [regionId], references: [id])

  mealCategoryId String?
  mealCategory   MealCategory? @relation(fields: [mealCategoryId], references: [id])

  ingredients RecipeIngredient[]

  // Dietary flags (computed from ingredients)
  isVeg            Boolean @default(false)
  isVegan          Boolean @default(false)
  dairyFree        Boolean @default(true)
  nutFree          Boolean @default(true)
  glutenFree       Boolean @default(true)
  diabetesFriendly Boolean @default(false)

  // Search optimizations
  searchVector Unsupported("tsvector")?
  embedding    Unsupported("vector(768)")?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum RecipeDifficulty {
  EASY
  MEDIUM
  HARD
}

model RecipeIngredient {
  id String @id @default(uuid())

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id])

  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  quantity   Float?
  unit       String?
  isOptional Boolean @default(false)
}

model Region {
  id          String   @id @default(uuid())
  countryCode String
  stateCode   String?
  name        String
  type        String
  parentId    String?
  parent      Region?  @relation("RegionParent", fields: [parentId], references: [id])
  children    Region[] @relation("RegionParent")

  users   User[]
  recipes Recipe[] @relation("RecipeRegion")
}
