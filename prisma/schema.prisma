// ============================================
// OPTIMIZED SCHEMA: Meal with Embedded Ingredients
// This is a denormalized approach for BLAZING FAST searches
// ============================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pg_trgm]
}

enum UserRole {
  ADMIN
  USER
}

// ============================================
// USER MODELS (No Change)
// ============================================

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  phoneNumber  String? @unique
  name         String

  role      UserRole @default(USER)
  stateCode String?
  regionId  String?

  tokenSet       TokenSet?
  sessions       UserSession[]
  dietaryProfile UserDietProfile?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  region    Region?  @relation(fields: [regionId], references: [id])
}

model TokenSet {
  userId      String   @id
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshHash String?
  updatedAt   DateTime @updatedAt
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  device       String?
  ipAddress    String?
  userAgent    String?
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([lastActivity])
}

model UserDietProfile {
  userId String @id
  user   User   @relation(fields: [userId], references: [id])

  vegType        String
  dairyFree      Boolean  @default(false)
  nutFree        Boolean  @default(false)
  glutenFree     Boolean  @default(false)
  hasDiabetes    Boolean  @default(false)
  otherAllergies String[]

  updatedAt DateTime @updatedAt
}

// ============================================
// INGREDIENT MODELS (Keep for management)
// ============================================

model IngredientCategory {
  id          String       @id @default(uuid())
  name        String
  description String
  ingredients Ingredient[]
}

model Ingredient {
  id      String   @id @default(uuid())
  name    String   @unique
  slug    String   @unique
  aliases String[] @default([])

  categoryId String?
  category   IngredientCategory? @relation(fields: [categoryId], references: [id])

  isVeg   Boolean @default(true)
  isVegan Boolean @default(true)

  isDairy  Boolean @default(false)
  isNut    Boolean @default(false)
  isGluten Boolean @default(false)

  tags String[] @default([])

  recipes RecipeIngredient[]

  @@index([name])
  @@index([categoryId])
}

model MealCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  recipes     Recipe[]
  meals       Meal[] // New relation
}

// ============================================
// OLD RECIPE MODEL (Keep for detailed view)
// ============================================

model Recipe {
  id String @id @default(uuid())

  title            String
  slug             String  @unique
  shortDescription String?
  instructions     String
  imageUrl         String?

  cookingTimeMinutes Int?
  difficulty         RecipeDifficulty @default(EASY)

  regionId String?
  region   Region? @relation("RecipeRegion", fields: [regionId], references: [id])

  mealCategoryId String?
  mealCategory   MealCategory? @relation(fields: [mealCategoryId], references: [id])

  ingredients RecipeIngredient[]

  isVeg            Boolean @default(false)
  isVegan          Boolean @default(false)
  dairyFree        Boolean @default(true)
  nutFree          Boolean @default(true)
  glutenFree       Boolean @default(true)
  diabetesFriendly Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mealCategoryId])
  @@index([regionId])
  @@index([isVeg, isVegan, dairyFree, nutFree, glutenFree, diabetesFriendly])
  @@index([slug])
}

enum RecipeDifficulty {
  EASY
  MEDIUM
  HARD
}

model RecipeIngredient {
  id String @id @default(uuid())

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  quantity   Float?
  unit       String?
  isOptional Boolean @default(false)

  @@index([recipeId])
  @@index([ingredientId])
}

// ============================================
// NEW OPTIMIZED MEAL MODEL
// Denormalized for SUPER FAST searches
// ============================================

model Meal {
  id String @id @default(uuid())

  title            String
  slug             String  @unique
  shortDescription String?
  instructions     String
  imageUrl         String?

  cookingTimeMinutes Int?
  difficulty         RecipeDifficulty @default(EASY)

  // Relations
  regionId String?
  region   Region? @relation("MealRegion", fields: [regionId], references: [id])

  mealCategoryId String?
  mealCategory   MealCategory? @relation(fields: [mealCategoryId], references: [id])


  ingredientIds   String[] 
  ingredientNames String[] 
  ingredientSlugs String[] 

  // Dietary flags (precomputed)
  isVeg            Boolean @default(false)
  isVegan          Boolean @default(false)
  dairyFree        Boolean @default(true)
  nutFree          Boolean @default(true)
  glutenFree       Boolean @default(true)
  diabetesFriendly Boolean @default(false)

  
  searchText String? // Precomputed: "title + description + ingredients"

  // Stats (can be updated periodically)
  viewCount  Int @default(0)
  clickCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ðŸ”¥ CRITICAL INDEXES for fast array searches
  @@index([ingredientNames(ops: raw("gin_trgm_ops"))], type: Gin)
  @@index([mealCategoryId])
  @@index([regionId])
  @@index([isVeg, isVegan, dairyFree, nutFree, glutenFree, diabetesFriendly])
  @@index([slug])
  @@index([clickCount]) 
}

// ============================================
// REGION MODEL 
// ============================================

model Region {
  id          String   @id @default(uuid())
  countryCode String
  stateCode   String?
  name        String
  type        String
  parentId    String?
  parent      Region?  @relation("RegionParent", fields: [parentId], references: [id])
  children    Region[] @relation("RegionParent")

  users   User[]
  recipes Recipe[] @relation("RecipeRegion")
  meals   Meal[]   @relation("MealRegion") // New relation

  @@index([parentId])
  @@index([countryCode])
}


// ============================================
// SCHEMA STRATEGY EXPLANATION
// ============================================

/*
WHY TWO MODELS (Recipe + Meal)?

1. RECIPE MODEL:
   - Normalized (proper relational design)
   - Used for CRUD operations (create, update, delete)
   - Used for detailed recipe view
   - Maintains data integrity
   - Easy to update ingredients

2. MEAL MODEL:
   - Denormalized (optimized for reads)
   - Used for SEARCH operations only
   - Precomputed/cached data
   - BLAZING FAST queries (no JOINs!)
   - Array operations on ingredients

WORKFLOW:
1. Admin creates/updates RECIPE (normalized)
2. Trigger automatically syncs to MEAL (denormalized)
3. User searches MEAL (super fast!)
4. User clicks â†’ show detailed RECIPE

*/