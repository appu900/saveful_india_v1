generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pg_trgm]
}

enum UserRole {
  ADMIN
  USER
  CHEF
}

enum RecipeDifficulty {
  EASY
  MEDIUM
  HARD
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
  ALL_SEASON
}

enum IngredientType {
  VEGETABLE
  FRUIT
  GRAIN
  PROTEIN
  DAIRY
  SPICE
  OIL
  OTHER
}

// ============================================
// USER MODELS
// ============================================

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  phoneNumber  String? @unique
  name         String

  role      UserRole @default(USER)
  stateCode String?
  regionId  String?

  tokenSet       TokenSet?
  sessions       UserSession[]
  dietaryProfile UserDietProfile?
  
  // New: User interactions
  cookedMeals    CookedMeal[]
  bookmarkedMeals BookmarkedMeal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  region    Region?  @relation(fields: [regionId], references: [id])
}

model TokenSet {
  userId      String   @id
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshHash String?
  updatedAt   DateTime @updatedAt
}

model UserSession {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  device       String?
  ipAddress    String?
  userAgent    String?
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([lastActivity])
}

model UserDietProfile {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  vegType        String
  dairyFree      Boolean  @default(false)
  nutFree        Boolean  @default(false)
  glutenFree     Boolean  @default(false)
  hasDiabetes    Boolean  @default(false)
  otherAllergies String[]

  updatedAt DateTime @updatedAt
}

// ============================================
// NEW: USER MEAL INTERACTIONS
// ============================================

model CookedMeal {
  id String @id @default(uuid())
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  mealId String
  meal   Meal   @relation(fields: [mealId], references: [id], onDelete: Cascade)
  
  cookedAt DateTime @default(now())
  rating   Int?     @default(0) // 1-5 stars
  notes    String?  // User's cooking notes
  
  @@unique([userId, mealId, cookedAt])
  @@index([userId])
  @@index([mealId])
  @@index([cookedAt])
}

model BookmarkedMeal {
  id String @id @default(uuid())
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  mealId String
  meal   Meal   @relation(fields: [mealId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, mealId])
  @@index([userId])
  @@index([mealId])
}

// ============================================
// UPDATED INGREDIENT MODELS WITH NEW FIELDS
// ============================================

model IngredientCategory {
  id          String       @id @default(uuid())
  name        String       @unique
  description String
  ingredients Ingredient[]
}

model Ingredient {
  id      String   @id @default(uuid())
  name    String   @unique
  slug    String   @unique
  aliases String[] @default([])

  // NEW: Image and descriptions
  imageUrl         String? // S3 URL for ingredient image
  description      String? // General description
  nutritionInfo    String? // Nutritional information (JSON string or text)
  
  // NEW: Type and Season
  type             IngredientType @default(OTHER)
  isVegetable      Boolean        @default(false)
  isFruit          Boolean        @default(false)
  availableSeasons Season[]       @default([ALL_SEASON]) // When ingredient is in season

  categoryId String?
  category   IngredientCategory? @relation(fields: [categoryId], references: [id])

  // Dietary properties
  isVeg   Boolean @default(true)
  isVegan Boolean @default(true)
  isDairy  Boolean @default(false)
  isNut    Boolean @default(false)
  isGluten Boolean @default(false)

  tags String[] @default([])
  
  // NEW: Who added this ingredient
  addedBy     UserRole @default(ADMIN) // ADMIN or CHEF
  isVerified  Boolean  @default(false) // Admin verification flag

  recipes RecipeIngredient[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([slug])
  @@index([categoryId])
  @@index([type])
  @@index([isVegetable, isFruit])
  @@index([availableSeasons])
  @@index([isVerified])
}

model MealCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  recipes     Recipe[]
  meals       Meal[]
}

// ============================================
// RECIPE MODEL (Keep for reference)
// ============================================

model Recipe {
  id String @id @default(uuid())

  title            String
  slug             String  @unique
  shortDescription String?
  instructions     String
  imageUrl         String?

  cookingTimeMinutes Int?
  difficulty         RecipeDifficulty @default(EASY)

  regionId String?
  region   Region? @relation("RecipeRegion", fields: [regionId], references: [id])

  mealCategoryId String?
  mealCategory   MealCategory? @relation(fields: [mealCategoryId], references: [id])

  ingredients RecipeIngredient[]

  isVeg            Boolean @default(false)
  isVegan          Boolean @default(false)
  dairyFree        Boolean @default(true)
  nutFree          Boolean @default(true)
  glutenFree       Boolean @default(true)
  diabetesFriendly Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([mealCategoryId])
  @@index([regionId])
  @@index([isVeg, isVegan, dairyFree, nutFree, glutenFree, diabetesFriendly])
  @@index([slug])
}

model RecipeIngredient {
  id String @id @default(uuid())

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])

  quantity   Float?
  unit       String?
  isOptional Boolean @default(false)

  @@index([recipeId])
  @@index([ingredientId])
}

// ============================================
// OPTIMIZED MEAL MODEL FOR FAST SEARCH
// ============================================

model Meal {
  id String @id @default(uuid())

  title            String
  slug             String  @unique
  shortDescription String?
  instructions     String
  imageUrl         String?

  cookingTimeMinutes Int?
  difficulty         RecipeDifficulty @default(EASY)

  // Relations
  regionId String?
  region   Region? @relation("MealRegion", fields: [regionId], references: [id])

  mealCategoryId String?
  mealCategory   MealCategory? @relation(fields: [mealCategoryId], references: [id])

  // ðŸš€ DENORMALIZED: Embedded ingredient data for fast search
  ingredientIds   String[] @default([])
  ingredientNames String[] @default([])
  ingredientSlugs String[] @default([])

  // Dietary flags (precomputed)
  isVeg            Boolean @default(false)
  isVegan          Boolean @default(false)
  dairyFree        Boolean @default(true)
  nutFree          Boolean @default(true)
  glutenFree       Boolean @default(true)
  diabetesFriendly Boolean @default(false)

  // Search optimization
  searchText String?

  // Stats
  viewCount  Int @default(0)
  clickCount Int @default(0)
  
  // NEW: User interactions
  cookedByUsers    CookedMeal[]
  bookmarkedByUsers BookmarkedMeal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ðŸ”¥ FIXED INDEXES - Separate for arrays and text
  @@index([mealCategoryId])
  @@index([regionId])
  @@index([isVeg, isVegan, dairyFree, nutFree, glutenFree, diabetesFriendly])
  @@index([slug])
  @@index([clickCount])
  @@index([createdAt])
}

// ============================================
// REGION MODEL
// ============================================

model Region {
  id          String   @id @default(uuid())
  countryCode String
  stateCode   String?
  name        String
  type        String
  parentId    String?
  parent      Region?  @relation("RegionParent", fields: [parentId], references: [id])
  children    Region[] @relation("RegionParent")

  users   User[]
  recipes Recipe[] @relation("RecipeRegion")
  meals   Meal[]   @relation("MealRegion")

  @@index([parentId])
  @@index([countryCode])
}


// ============================================
// POST-MIGRATION SQL - Run this AFTER migration
// Save this as: prisma/migrations/post-migrate.sql
// ============================================

/*
-- Enable pg_trgm extension if not already enabled
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- Create GIN index for ingredient names array (for overlap searches)
-- This uses default array operators, NOT gin_trgm_ops
CREATE INDEX IF NOT EXISTS "Meal_ingredientNames_array_idx" 
  ON "Meal" USING GIN ("ingredientNames");

-- Create GIN index for searchText with trigram (for text search)
CREATE INDEX IF NOT EXISTS "Meal_searchText_trgm_idx" 
  ON "Meal" USING GIN ("searchText" gin_trgm_ops);

-- Create GIN index for ingredient names with trigram (for fuzzy matching individual names)
CREATE INDEX IF NOT EXISTS "Ingredient_name_trgm_idx" 
  ON "Ingredient" USING GIN ("name" gin_trgm_ops);

-- Create GIN index for ingredient aliases array
CREATE INDEX IF NOT EXISTS "Ingredient_aliases_array_idx" 
  ON "Ingredient" USING GIN ("aliases");

-- Create GIN index for ingredient seasons array
CREATE INDEX IF NOT EXISTS "Ingredient_availableSeasons_array_idx" 
  ON "Ingredient" USING GIN ("availableSeasons");
*/